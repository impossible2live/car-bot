"""
Модуль для работы с поколениями автомобилей.
Простая версия - только года без названий поколений.
"""

from typing import Dict, List, Tuple, Optional
from functools import lru_cache

# База данных поколений в упрощенном формате: марка -> модель -> список диапазонов годов
CAR_GENERATIONS_DB = {
    "Toyota": {
        "Camry": [(2001, 2006), (2006, 2011), (2011, 2017), (2017, 2024)],
        "Corolla": [(2000, 2006), (2006, 2012), (2013, 2018), (2018, 2023)],
        "RAV4": [(2005, 2012), (2012, 2018), (2018, 2022)],
        "Prius": [(2003, 2009), (2009, 2015), (2015, 2022)],
        "Land Cruiser": [(1997, 2007), (2007, 2021), (2021, 2024)],
        "Hilux": [(2004, 2011), (2011, 2015), (2015, 2020), (2020, 2024)],
        "Highlander": [(2000, 2007), (2007, 2013), (2013, 2019), (2019, 2024)],
        "Avensis": [(1997, 2003), (2003, 2008), (2008, 2015), (2015, 2018)],
        "Yaris": [(1999, 2005), (2005, 2011), (2011, 2014), (2014, 2020), (2020, 2024)],
    },
    "Lada": {
    "Vesta": [(2015, 2020), (2020, 2024)],
    "Granta": [(2011, 2018), (2018, 2024)],
    "Kalina": [(2004, 2013), (2013, 2018)],
    "Priora": [(2007, 2014)],

    "Niva": [(1977, 2003), (1993, 2006), (2014, 2020), (2020, 2024)],
    "Niva Travel": [(2020, 2024)],
    "XRAY": [(2016, 2024)],
    "4x4 Urban": [(2014, 2020)],

    "Largus": [(2012, 2022), (2022, 2024)],
    "Vesta SW": [(2015, 2020), (2020, 2024)],
    "Granta Liftback": [(2011, 2018), (2018, 2024)],
    "Largus Van": [(2012, 2024)],

    "2101": [(1970, 1988)],
    "2102": [(1971, 1985)],
    "2103": [(1972, 1984)],
    "2104": [(1984, 2012)],
    "2105": [(1980, 2010)],
    "2106": [(1976, 2006)],
    "2107": [(1982, 2012)],
    "2108": [(1984, 2004)],
    "2109": [(1987, 2004)],
    "21099": [(1990, 2004)],

    "2110": [(1995, 2007)],
    "2111": [(1997, 2009)],
    "2112": [(1997, 2008)],
    "2113": [(2004, 2014)],
    "2114": [(2001, 2013)],
    "2115": [(1997, 2012)],

    "Vesta Sport": [(2020, 2024)],
    "Priora Coupe": [(2008, 2014)],
    "Kalina Sport": [(2011, 2018)],

    "UAZ Patriot": [(2005, 2016), (2016, 2024)],
    "UAZ Hunter": [(2003, 2024)],
    "UAZ Pickup": [(2008, 2024)],

    "Volga 21": [(1956, 1970)],
    "Volga 24": [(1970, 1985)],
    "Volga 3102": [(1982, 2009)],
    "Volga 3110": [(1997, 2009)],
    "Gazelle": [(1994, 2010), (2010, 2024)],

    "Moskvich 2140": [(1976, 1988)],
    "Moskvich 2141": [(1986, 2001)],
    "Moskvich 412": [(1967, 1976)],

    "Lada Concept": [(2018, 2024)],
    "Lada e-Largus": [(2023, 2024)],
    },
    "BMW": {
        "3 Series": [(1998, 2005), (2005, 2013), (2011, 2019), (2018, 2024)],
        "5 Series": [(2003, 2010), (2009, 2017), (2016, 2023)],
        "7 Series": [(2001, 2008), (2008, 2015), (2015, 2022)],
        "X5": [(1999, 2006), (2006, 2013), (2013, 2018), (2018, 2023)],
        "X3": [(2003, 2010), (2010, 2017), (2017, 2024)],
        "X6": [(2008, 2014), (2014, 2019), (2019, 2024)],
        "X1": [(2009, 2015), (2015, 2022), (2022, 2024)],
        "M3": [(2000, 2006), (2007, 2013), (2014, 2018), (2018, 2024)],
    },
    "Audi": {
        "A4": [(2000, 2005), (2004, 2008), (2007, 2015), (2015, 2024)],
        "A6": [(1997, 2004), (2004, 2011), (2011, 2018), (2018, 2024)],
        "A8": [(2002, 2010), (2010, 2017), (2017, 2024)],
        "Q5": [(2008, 2016), (2016, 2023), (2023, 2024)],
        "Q7": [(2005, 2015), (2015, 2020), (2020, 2024)],
        "A3": [(1996, 2003), (2003, 2012), (2012, 2020), (2020, 2024)],
        "TT": [(1998, 2006), (2006, 2014), (2014, 2023)],
        "Q3": [(2011, 2018), (2018, 2024)],
    },
    "Volkswagen": {
        "Golf": [(1997, 2003), (2003, 2008), (2008, 2012), (2012, 2019), (2019, 2024)],
        "Passat": [(1996, 2000), (2000, 2005), (2005, 2010), (2010, 2014), (2014, 2019), (2019, 2024)],
        "Tiguan": [(2007, 2011), (2011, 2016), (2016, 2021), (2021, 2024)],
        "Polo": [(2001, 2005), (2005, 2009), (2009, 2014), (2014, 2019), (2019, 2024)],
        "Jetta": [(2005, 2010), (2010, 2018), (2018, 2024)],
        "Touareg": [(2002, 2010), (2010, 2018), (2018, 2024)],
        "Caddy": [(2003, 2010), (2010, 2015), (2015, 2020), (2020, 2024)],
        "Transporter": [(2003, 2009), (2009, 2015), (2015, 2024)],
    },
    "Skoda": {
        "Octavia": [(1996, 2004), (2004, 2013), (2013, 2020), (2020, 2024)],
        "Fabia": [(1999, 2007), (2007, 2014), (2014, 2021), (2021, 2024)],
        "Kodiaq": [(2016, 2021), (2021, 2024)],
        "Karoq": [(2017, 2024)],
        "Superb": [(2001, 2008), (2008, 2015), (2015, 2019), (2019, 2024)],
        "Rapid": [(2012, 2017), (2017, 2020), (2020, 2024)],
    },
    "Nissan": {
        "Qashqai": [(2006, 2013), (2013, 2021), (2021, 2024)],
        "X-Trail": [(2000, 2007), (2007, 2013), (2013, 2021), (2021, 2024)],
        "Almera": [(1995, 2000), (2000, 2006), (2012, 2024)],
        "Teana": [(2003, 2008), (2008, 2013), (2013, 2018)],
        "Murano": [(2002, 2007), (2007, 2015), (2015, 2021), (2021, 2024)],
        "Patrol": [(1997, 2010), (2010, 2024)],
        "Juke": [(2010, 2014), (2014, 2019), (2019, 2024)],
        "Note": [(2004, 2012), (2012, 2020)],
    },
    "Hyundai": {
        "Solaris": [(2010, 2014), (2014, 2017), (2017, 2024)],
        "Tucson": [(2004, 2009), (2009, 2015), (2015, 2020), (2020, 2024)],
        "Creta": [(2016, 2020), (2020, 2024)],
        "Santa Fe": [(2000, 2006), (2006, 2012), (2012, 2018), (2018, 2024)],
        "Elantra": [(2000, 2006), (2006, 2010), (2010, 2015), (2015, 2020), (2020, 2024)],
        "Sonata": [(1998, 2004), (2004, 2009), (2009, 2014), (2014, 2019), (2019, 2024)],
        "Accent": [(1999, 2005), (2005, 2010), (2010, 2017), (2017, 2024)],
        "ix35": [(2009, 2015)],
    },
    "Kia": {
        "Rio": [(2005, 2011), (2011, 2017), (2017, 2021), (2021, 2024)],
        "Sportage": [(2004, 2010), (2010, 2016), (2016, 2021), (2021, 2024)],
        "Sorento": [(2002, 2009), (2009, 2014), (2014, 2020), (2020, 2024)],
        "Optima": [(2010, 2015), (2015, 2020)],
        "Ceed": [(2006, 2012), (2012, 2018), (2018, 2024)],
        "Cerato": [(2004, 2009), (2009, 2013), (2013, 2018), (2018, 2024)],
        "Soul": [(2008, 2014), (2014, 2019), (2019, 2024)],
        "Stinger": [(2017, 2021), (2021, 2024)],
    },
    "Mercedes-Benz": {
        "C-Class": [(2000, 2007), (2007, 2014), (2014, 2021), (2021, 2024)],
        "E-Class": [(2002, 2009), (2009, 2016), (2016, 2023)],
        "S-Class": [(1998, 2005), (2005, 2013), (2013, 2020), (2020, 2024)],
        "GLC": [(2015, 2022), (2022, 2024)],
        "GLE": [(2011, 2018), (2018, 2024)],
        "GLA": [(2013, 2020), (2020, 2024)],
        "CLS": [(2004, 2010), (2010, 2018), (2018, 2024)],
        "ML": [(1997, 2005), (2005, 2011), (2011, 2015)],
    },
    "Ford": {
        "Focus": [(1998, 2004), (2004, 2010), (2010, 2014), (2014, 2018), (2018, 2024)],
        "Mondeo": [(2000, 2007), (2007, 2014), (2014, 2022)],
        "Kuga": [(2008, 2012), (2012, 2019), (2019, 2024)],
        "Fiesta": [(2002, 2008), (2008, 2013), (2013, 2017), (2017, 2024)],
        "Explorer": [(2002, 2005), (2005, 2010), (2010, 2015), (2015, 2020), (2020, 2024)],
        "Mustang": [(2004, 2009), (2009, 2014), (2014, 2023)],
        "Transit": [(2000, 2006), (2006, 2013), (2013, 2020), (2020, 2024)],
    },
    "Renault": {
        "Logan": [(2004, 2009), (2009, 2012), (2012, 2018), (2018, 2021), (2021, 2024)],
        "Duster": [(2010, 2015), (2015, 2021), (2021, 2024)],
        "Sandero": [(2007, 2012), (2012, 2018), (2018, 2021), (2021, 2024)],
        "Kaptur": [(2016, 2024)],
        "Arkana": [(2019, 2024)],
        "Megane": [(2002, 2008), (2008, 2016), (2016, 2024)],
        "Fluence": [(2009, 2014)],
        "Koleos": [(2007, 2012), (2012, 2016), (2016, 2024)],
    },
    "Chevrolet": {
        "Niva": [(2002, 2009), (2009, 2020)],
        "Lacetti": [(2002, 2008), (2008, 2011)],
        "Aveo": [(2002, 2006), (2006, 2011), (2011, 2015), (2015, 2020)],
        "Cruze": [(2008, 2012), (2012, 2016), (2016, 2024)],
        "Malibu": [(1997, 2003), (2003, 2008), (2008, 2012), (2012, 2016), (2016, 2024)],
        "Tahoe": [(1999, 2006), (2006, 2014), (2014, 2020), (2020, 2024)],
        "Captiva": [(2006, 2011), (2011, 2018)],
        "Orlando": [(2010, 2015), (2015, 2018)],
    },
    "Mitsubishi": {
        "Outlander": [(2001, 2005), (2005, 2012), (2012, 2018), (2018, 2024)],
        "Pajero": [(1999, 2006), (2006, 2014), (2014, 2024)],
        "Lancer": [(2000, 2007), (2007, 2010), (2010, 2017), (2017, 2024)],
        "ASX": [(2010, 2013), (2013, 2019), (2019, 2024)],
        "Pajero Sport": [(1998, 2008), (2008, 2015), (2015, 2024)],
    },
    "Mazda": {
        "CX-5": [(2011, 2016), (2016, 2021), (2021, 2024)],
        "6": [(2002, 2008), (2008, 2012), (2012, 2017), (2017, 2024)],
        "3": [(2003, 2009), (2009, 2013), (2013, 2019), (2019, 2024)],
        "CX-7": [(2006, 2012)],
        "CX-9": [(2006, 2016), (2016, 2024)],
    },
    "Lexus": {
        "RX": [(1997, 2003), (2003, 2009), (2009, 2015), (2015, 2022), (2022, 2024)],
        "ES": [(2001, 2006), (2006, 2012), (2012, 2018), (2018, 2024)],
        "LX": [(1995, 2007), (2007, 2015), (2015, 2021), (2021, 2024)],
        "IS": [(1998, 2005), (2005, 2013), (2013, 2020), (2020, 2024)],
        "NX": [(2014, 2021), (2021, 2024)],
    },
    "Subaru": {
        "Forester": [(1997, 2002), (2002, 2008), (2008, 2013), (2013, 2018), (2018, 2024)],
        "Outback": [(1994, 1999), (1999, 2004), (2004, 2009), (2009, 2014), (2014, 2019), (2019, 2024)],
        "Impreza": [(2000, 2007), (2007, 2011), (2011, 2016), (2016, 2024)],
        "Legacy": [(1994, 1999), (1999, 2003), (2003, 2009), (2009, 2014), (2014, 2020), (2020, 2024)],
    },
    "Honda": {
        "CR-V": [(1995, 2001), (2001, 2006), (2006, 2011), (2011, 2016), (2016, 2024)],
        "Civic": [(2000, 2005), (2005, 2011), (2011, 2015), (2015, 2021), (2021, 2024)],
        "Accord": [(1997, 2002), (2002, 2008), (2008, 2015), (2015, 2024)],
        "Pilot": [(2002, 2008), (2008, 2015), (2015, 2022), (2022, 2024)],
    },
    "Peugeot": {
        "308": [(2007, 2011), (2011, 2014), (2014, 2017), (2017, 2021), (2021, 2024)],
        "3008": [(2008, 2016), (2016, 2024)],
        "408": [(2010, 2014), (2014, 2018), (2018, 2024)],
        "Partner": [(1996, 2002), (2002, 2008), (2008, 2015), (2015, 2018), (2018, 2024)],
    },
    "Citroen": {
        "C4": [(2004, 2010), (2010, 2018), (2018, 2024)],
        "C5": [(2000, 2004), (2004, 2008), (2008, 2017), (2017, 2021)],
        "Berlingo": [(1996, 2002), (2002, 2008), (2008, 2018), (2018, 2024)],
        "C3": [(2002, 2009), (2009, 2016), (2016, 2024)],
    },
    "Mazda": {
        "6": [(2002, 2007), (2007, 2012), (2012, 2017), (2017, 2024)],
        "3": [(2003, 2009), (2009, 2013), (2013, 2019), (2019, 2024)],
        "CX-5": [(2011, 2016), (2016, 2021), (2021, 2024)],
        "CX-7": [(2006, 2012)],
        "CX-9": [(2006, 2016), (2016, 2024)],
    },

    "Haval": {
        "H6": [(2011, 2017), (2017, 2020), (2020, 2024)],
        "H9": [(2014, 2017), (2017, 2020), (2020, 2024)],
    },

    "Geely": {
        "Coolray": [(2019, 2024)],
        "Atlas": [(2018, 2024)],
    },

    "Chery": {
        "Tiggo 7": [(2016, 2020), (2020, 2024)],
        "Tiggo 8": [(2018, 2024)],
    },

    "BYD": {
        "Song Plus": [(2020, 2024)],
        "Han": [(2020, 2024)],
    },
}

BRAND_TRANSLATIONS = {
    "Toyota": "Тойота", "Honda": "Хонда", "BMW": "БМВ", "Audi": "Ауди",
    "Mercedes-Benz": "Мерседес", "Ford": "Форд", "Nissan": "Ниссан",
    "Hyundai": "Хендай", "Kia": "Киа", "Volkswagen": "Фольксваген",
    "Skoda": "Шкода", "Renault": "Рено", "Peugeot": "Пежо",
    "Citroen": "Ситроен", "Mitsubishi": "Мицубиси", "Mazda": "Мазда",
    "Subaru": "Субару", "Lexus": "Лексус", "Chevrolet": "Шевроле",
    "Lada": "Лада", "ВАЗ": "Lada", "Лада": "Lada",
    "Тойота": "Toyota", "Хонда": "Honda", "БМВ": "BMW", "Ауди": "Audi",
    "Мерседес": "Mercedes-Benz", "Форд": "Ford", "Ниссан": "Nissan",
    "Хендай": "Hyundai", "Киа": "Kia", "Фольксваген": "Volkswagen",
    "Шкода": "Skoda", "Рено": "Renault", "Пежо": "Peugeot",
    "Ситроен": "Citroen", "Мицубиси": "Mitsubishi", "Мазда": "Mazda",
    "Субару": "Subaru", "Лексус": "Lexus", "Шевроле": "Chevrolet",
}

MODEL_TRANSLATIONS = {
    "Camry": "Камри", "Corolla": "Королла", "RAV4": "РАВ4",
    "Vesta": "Веста", "Granta": "Гранта", "Niva": "Нива",
    "Octavia": "Октавия", "Fabia": "Фабия", "3 Series": "3 серии",
    "5 Series": "5 серии", "X5": "Икс5", "A4": "А4", "A6": "А6",
    "Golf": "Гольф", "Passat": "Пассат", "Qashqai": "Кашкай",
    "X-Trail": "Икс-Трейл", "Solaris": "Солярис", "Tucson": "Тусон",
    "Creta": "Крета", "Rio": "Рио", "Sportage": "Спортейдж",
    "Focus": "Фокус", "Mondeo": "Мондео", "Logan": "Логан",
    "Duster": "Дастер", "Lacetti": "Лачетти", "Aveo": "Авео",
    "Outlander": "Аутлендер", "Pajero": "Паджеро", "CX-5": "СИкс-5",
    "CR-V": "СиАр-Ви", "Civic": "Сивик", "308": "триста восемь",
    "C4": "Си4", "C5": "Си5", "Камри": "Camry", "Королла": "Corolla",
    "РАВ4": "RAV4", "Веста": "Vesta", "Гранта": "Granta",
    "Нива": "Niva", "Октавия": "Octavia", "Фабия": "Fabia",
    "3 серии": "3 Series", "5 серии": "5 Series", "Икс5": "X5",
    "А4": "A4", "А6": "A6", "Гольф": "Golf", "Пассат": "Passat",
    "Кашкай": "Qashqai", "Икс-Трейл": "X-Trail", "Солярис": "Solaris",
    "Тусон": "Tucson", "Крета": "Creta", "Рио": "Rio",
    "Спортейдж": "Sportage", "Фокус": "Focus", "Мондео": "Mondeo",
    "Логан": "Logan", "Дастер": "Duster", "Лачетти": "Lacetti",
    "Авео": "Aveo", "Аутлендер": "Outlander", "Паджеро": "Pajero",
    "Сикс-5": "CX-5", "СиАр-Ви": "CR-V", "Сивик": "Civic",
}


@lru_cache(maxsize=512)
def find_generation_for_year(brand: str, model: str, year: int) -> Optional[Tuple[int, int]]:
    brand_lower = brand.strip().lower()
    model_lower = model.strip().lower()

    brand_eng = BRAND_TRANSLATIONS.get(brand, brand)
    model_eng = MODEL_TRANSLATIONS.get(model, model)

    for db_brand, models in CAR_GENERATIONS_DB.items():
        if db_brand.lower() == brand_lower or db_brand.lower() == brand_eng.lower():
            for db_model, generations in models.items():
                if (db_model.lower() == model_lower or
                        db_model.lower() == model_eng.lower() or
                        model_lower in db_model.lower() or
                        db_model.lower() in model_lower):

                    for start_year, end_year in generations:
                        if start_year <= year <= end_year:
                            return (start_year, end_year)

    return None


@lru_cache(maxsize=512)
def get_generation_years(brand: str, model: str, year: int) -> Tuple[int, int]:
    result = find_generation_for_year(brand, model, year)

    if result:
        return result

    if year <= 1980:
        return (year, year + 20)
    elif year <= 2000:
        return (year, year + 8)
    elif year <= 2010:
        return (year - 2, year + 5)
    else:
        return (year - 3, year + 4)


def get_all_years_for_generation(brand: str, model: str, year: int) -> List[int]:
    start_year, end_year = get_generation_years(brand, model, year)
    return list(range(start_year, end_year + 1))


def apply_generation_filter(filters: Dict, brand: str, model: str) -> Dict:
    if 'year' in filters and filters['year']:
        try:
            year = int(str(filters['year']).strip())
            start_year, end_year = get_generation_years(brand, model, year)

            del filters['year']
            filters['year_from'] = start_year
            filters['year_to'] = end_year

        except (ValueError, TypeError):
            pass

    return filters


def get_available_years_for_model(brand: str, model: str) -> List[int]:
    brand_lower = brand.strip().lower()
    model_lower = model.strip().lower()

    years_set = set()

    for db_brand, models in CAR_GENERATIONS_DB.items():
        if db_brand.lower() == brand_lower:
            for db_model, generations in models.items():
                if db_model.lower() == model_lower:
                    for start_year, end_year in generations:
                        years_list = list(range(start_year, end_year + 1))
                        years_set.update(years_list)

    return sorted(list(years_set))